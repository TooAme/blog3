<style>
  /* 预设选择器样式 */
  .background-selector {
    position: relative;
    width: 100%;
  }

  .background-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    user-select: none;
  }

  .background-selector-header:hover {
    border-color: #007bff;
  }

  .dropdown-arrow {
    transition: transform 0.3s ease;
  }

  .background-selector.open .dropdown-arrow {
    transform: rotate(180deg);
  }

  .background-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
  }

  .background-selector.open .background-dropdown {
    display: block;
  }

  .background-card {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
  }

  .background-card:hover {
    background-color: #f8f9fa;
  }

  .background-card:last-child {
    border-bottom: none;
  }

  .background-preview {
    width: 60px;
    height: 40px;
    margin-right: 12px;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    background: #f0f0f0;
    border: 1px solid #ddd;
  }

  .background-name {
    font-weight: 500;
    color: #333;
  }

  /* Matrix预览样式 - 静态显示 */
  .matrix-preview {
    width: 100%;
    height: 100%;
    background: #000;
    position: relative;
    overflow: hidden;
    display: flex;
  }

  .matrix-preview::before,
  .matrix-preview::after {
    content: "アイウエオカキクケコ123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    position: absolute;
    top: 0;
    width: 8px;
    height: 100%;
    font-size: 6px;
    line-height: 7px;
    font-weight: bold;
    color: transparent;
    background: linear-gradient(
      to bottom,
      #ffffff 0%,
      #ffffff 5%,
      #00ff41 10%,
      #00ff41 20%,
      #00dd33 30%,
      #00bb22 40%,
      #009911 50%,
      #007700 60%,
      #005500 70%,
      #003300 80%,
      rgba(0, 255, 65, 0.5) 90%,
      transparent 100%
    );
    -webkit-background-clip: text;
    background-clip: text;
    writing-mode: vertical-lr;
    letter-spacing: 0.5px;
    white-space: nowrap;
    /* 移除动画，显示静态效果 */
  }

  .matrix-preview::before {
    left: 15px;
  }

  .matrix-preview::after {
    left: 35px;
    content: "ガギグゲゴザジズゼゾダヂヅデドバビブベボパピプペポヴァィゥェォャュョッ";
  }

  /* 空白预设样式 */
  .blank-preview {
    background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 8px 8px;
    background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
  }

  /* 彩虹渐变预设样式 - 静态显示 */
  .gradient-preview {
    background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    /* 移除动画，显示静态效果 */
  }

  /* 粒子动画预设样式 - 静态显示 */
  .particles-preview {
    background: radial-gradient(circle, #1e3c72 0%, #2a5298 100%);
    position: relative;
    overflow: hidden;
  }

  .particles-preview::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image:
      radial-gradient(2px 2px at 20px 30px, #fff, transparent),
      radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
      radial-gradient(1px 1px at 90px 40px, #fff, transparent),
      radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent);
    background-repeat: repeat;
    background-size: 150px 100px;
    /* 移除动画，显示静态效果 */
  }

  /* 统一使用上下排列布局 */
  .background-generator-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    display: block;
  }

  .generator-left-panel,
  .generator-right-panel {
    width: 100%;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .generator-right-panel:last-child {
    margin-bottom: 0;
  }

  /* 大屏幕优化：增加内边距和间距 */
  @media (min-width: 768px) {
    .background-generator-container {
      padding: 30px;
    }

    .generator-left-panel,
    .generator-right-panel {
      padding: 30px;
      margin-bottom: 30px;
    }
  }

  /* 尺寸选择样式 */
  .size-selector {
    margin-bottom: 20px;
  }

  .size-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .size-option {
    padding: 12px 20px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    min-width: 140px;
    flex: 1;
    max-width: 200px;
  }

  .size-option:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
  }

  .size-option.selected {
    border-color: #007bff;
    background-color: #007bff;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  }

  .size-label {
    font-weight: bold;
    display: block;
    font-size: 16px;
  }

  .size-dimensions {
    font-size: 13px;
    color: #666;
    margin-top: 4px;
  }

  .size-option.selected .size-dimensions {
    color: rgba(255, 255, 255, 0.9);
  }

  /* 预览画布样式 */
  .layout-preview-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }

  #layout-preview-canvas {
    border: 2px solid #ddd;
    border-radius: 8px;
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s ease;
  }

  #layout-preview-canvas:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  /* 画布容器响应式调整 */
  @media (max-width: 1200px) {
    #layout-preview-canvas {
      max-width: 100%;
      width: 100%;
    }
  }

  /* 预览区域样式 */
  #preview-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  #preview-container .preview-text {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
  }

  #preview-container .preview-wrapper {
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #preview-container .preview-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  #preview-container .preview-controls .btn {
    padding: 10px 20px;
    font-size: 14px;
  }

  /* 预览图片样式 */
  #preview-gif {
    max-width: 100%;
    height: auto;
    border: 2px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* 横幅类型预览样式 */
  .preview-banner #preview-gif {
    width: 1067px;
    height: 300px;
    max-width: 100%;
  }

  /* 卡片类型预览样式 */
  .preview-card #preview-gif {
    width: 600px;
    height: 400px;
    max-width: 100%;
  }

  /* 响应式调整 */
  @media (max-width: 1200px) {
    .preview-banner #preview-gif {
      width: 100%;
      height: auto;
      aspect-ratio: 1067/300;
    }
  }

  @media (max-width: 768px) {
    .preview-card #preview-gif {
      width: 100%;
      height: auto;
      aspect-ratio: 600/400;
    }
  }

  .help-text {
    font-size: 12px;
    color: #666;
    margin-top: 10px;
    text-align: center;
  }

  .preview-section {
    padding-top: 0;
  }

  /* 控制按钮样式优化 */
  .preview-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .preview-controls .btn {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .preview-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  /* 背景透明度控制样式 */
  #bg-opacity-control {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    text-align: center;
  }

  #bg-opacity-slider {
    width: 200px;
    margin: 0 10px;
  }

  /* 颜色选择器样式 */
  .color-selector {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    background-color: #fafafa;
  }

  .color-mode-selector {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }

  .radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: normal;
  }

  .radio-label input[type="radio"] {
    margin-right: 5px;
  }

  .color-picker-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .color-picker-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .color-picker-group label {
    min-width: 60px;
    font-weight: normal;
    margin: 0;
  }

  .color-input {
    width: 50px;
    height: 35px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
  }

  .gradient-angle-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
  }

  .gradient-angle-group label {
    min-width: 60px;
    font-weight: normal;
    margin: 0;
  }

  .angle-input-container {
    position: relative;
    width: 120px;
    height: 30px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .angle-input-container:hover {
    border-color: #007bff;
  }

  .angle-input-container.active {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .angle-track {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
  }

  .angle-indicator {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #007bff;
    left: 25%;
    transition: left 0.1s ease;
  }

  .angle-value {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 35px;
    height: 20px;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 12px;
    color: #333;
  }

  .angle-value:focus {
    outline: none;
    background: white;
    border: 1px solid #007bff;
    border-radius: 2px;
  }
</style>

<!-- 合并的页面头部 -->
<div class="page-header">
  <h1><a class="brand" href="<%= config.root %>"><%= config.title %></a></h1>
  <h2><span class="title">动态背景生成器</span></h2>
</div>

<div class="row page">
  <div class="col-md-12">

    <div class="background-generator-container">
      <!-- 左侧面板：参数设置 -->
      <div class="generator-left-panel">
        <!-- 参数选择区域 -->
        <div id="parameter-section">
          <h3 style="margin-top: 0; margin-bottom: 25px; color: #333; text-align: center;">背景参数设置</h3>

        <!-- 尺寸类别选择 -->
        <div class="form-group size-selector">
          <label style="display: block; margin-bottom: 15px; font-weight: bold; color: #555; text-align: center;">选择尺寸类别</label>
          <div class="size-options">
            <div class="size-option selected" data-size="banner">
              <span class="size-label">横幅</span>
              <span class="size-dimensions">1067×300px</span>
            </div>
            <div class="size-option" data-size="card">
              <span class="size-label">卡片</span>
              <span class="size-dimensions">600×400px</span>
            </div>
          </div>
        </div>

        <!-- 背景预设选择 -->
        <div class="form-group">
          <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #555;">选择背景预设</label>
          <div class="background-selector" id="background-selector">
            <div class="background-selector-header" id="background-selector-header">
              <span class="selected-background-name">空白预设</span>
              <span class="dropdown-arrow">▼</span>
            </div>
            <div class="background-dropdown" id="background-dropdown">
              <div class="background-card" data-value="blank">
                <div class="background-preview">
                  <div class="blank-preview"></div>
                </div>
                <div class="background-name">空白预设</div>
              </div>
              <div class="background-card" data-value="matrix">
                <div class="background-preview">
                  <div class="matrix-preview"></div>
                </div>
                <div class="background-name">Matrix代码雨</div>
              </div>
              <div class="background-card" data-value="gradient">
                <div class="background-preview">
                  <div class="gradient-preview"></div>
                </div>
                <div class="background-name">彩虹渐变</div>
              </div>
              <div class="background-card" data-value="particles">
                <div class="background-preview">
                  <div class="particles-preview"></div>
                </div>
                <div class="background-name">粒子动画</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 昵称输入 -->
        <div class="form-group">
          <label for="nickname" style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">输入昵称</label>
          <input type="text" id="nickname" class="form-control" placeholder="请输入昵称" maxlength="20">
        </div>

        <!-- 昵称字体选择 -->
        <div class="form-group">
          <label for="font-select" style="display: block; margin-bottom: 8px; font-weight: bold; color: #555;">昵称字体</label>
          <select id="font-select" class="form-control">
            <option value="Microsoft YaHei">微软雅黑</option>
            <option value="YouYuan">幼圆</option>
            <option value="SimSun">宋体</option>
            <option value="KaiTi">楷体</option>
            <option value="FangSong">仿宋</option>
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Verdana">Verdana</option>
            <option value="Tahoma">Tahoma</option>
          </select>
        </div>

        <!-- 昵称颜色选择 -->
        <div class="form-group">
          <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #555;">昵称颜色</label>
          <div class="color-selector">
            <!-- 颜色模式选择 -->
            <div class="color-mode-selector">
              <label class="radio-label">
                <input type="radio" name="color-mode" value="single" checked>
                <span>单色</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="color-mode" value="gradient">
                <span>渐变</span>
              </label>
            </div>

            <!-- 颜色选择区域 -->
            <div class="color-picker-container">
              <div class="color-picker-group">
                <label for="color1">颜色1：</label>
                <input type="color" id="color1" value="#25A5D0" class="color-input">
              </div>
              <div class="color-picker-group" id="color2-group" style="display: none;">
                <label for="color2">颜色2：</label>
                <input type="color" id="color2" value="#88D5FB" class="color-input">
              </div>
              <!-- 渐变角度选择 -->
              <div class="gradient-angle-group" id="gradient-angle-group" style="display: none;">
                <label for="gradient-angle">角度：</label>
                <div class="angle-input-container" id="angle-input-container">
                  <div class="angle-track">
                    <div class="angle-indicator" id="angle-indicator"></div>
                  </div>
                  <input type="text" class="angle-value" id="angle-value" value="90" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 生成按钮 -->
        <div class="form-group">
          <button id="generate-btn" class="btn btn-primary btn-lg generate-btn">开始生成</button>
        </div>
        </div> <!-- 关闭parameter-section -->
      </div> <!-- 关闭generator-left-panel -->

      <!-- 预览面板：预览与布局调整 -->
      <div class="generator-right-panel">
        <!-- 布局预览 -->
        <div class="form-group preview-section">
          <h3 style="margin-top: 0; margin-bottom: 20px; color: #333; text-align: center;">预览与布局调整</h3>
          <div class="layout-preview-container">
            <canvas id="layout-preview-canvas" width="1067" height="300"></canvas>
            <div class="preview-controls">
              <button type="button" id="custom-bg-btn" class="btn btn-info btn-sm">自选背景</button>
              <button type="button" id="add-sticker-btn" class="btn btn-success btn-sm">添加贴图</button>
              <button type="button" id="reset-layout-btn" class="btn btn-secondary btn-sm">重置布局</button>
              <input type="file" id="bg-file-input" accept="image/*" style="display: none;">
              <input type="file" id="sticker-file-input" accept="image/*" style="display: none;">
              
              <!-- 背景透明度调整 -->
              <div id="bg-opacity-control" style="display: none; margin-top: 10px;">
                <label for="bg-opacity-slider" style="font-size: 12px; color: #666;">背景透明度：</label>
                <input type="range" id="bg-opacity-slider" min="0" max="100" value="100" style="width: 100px;">
                <span id="bg-opacity-value" style="font-size: 12px; color: #666;">100%</span>
              </div>
              <small class="help-text" id="help-text">单击选中 Q/E旋转 +/-缩放 R重置 Delete删除</small>
            </div>
          </div>
        </div> <!-- 关闭form-group preview-section -->
      </div> <!-- 关闭右侧面板 -->
    </div> <!-- 关闭主容器 -->

    <!-- 预览区域（居中显示） -->
    <div id="preview-container" style="display: none;">
      <p class="preview-text">预览</p>
      <div id="preview-area">
        <div class="preview-wrapper">
          <canvas id="preview-canvas" width="1067" height="300" style="display: none;"></canvas>
          <img id="preview-gif" style="display: none;" />
        </div>
      </div>
      <div class="preview-controls">
        <button id="download-gif-btn" class="btn btn-success">下载GIF</button>
        <button id="regenerate-btn" class="btn btn-secondary">重新生成</button>
      </div>
    </div>

    <!-- 加载动画 -->
    <div id="loading-container" style="display: none;">
      <div class="loading-wrapper">
        <div class="loader">
          <div class="loader-square"></div>
          <div class="loader-square"></div>
          <div class="loader-square"></div>
          <div class="loader-square"></div>
          <div class="loader-square"></div>
          <div class="loader-square"></div>
          <div class="loader-square"></div>
        </div>
        <div id="loading-text">准备中...</div>
      </div>
    </div>
  </div>
</div>

<!-- 隐藏的canvas用于处理 -->
<canvas id="hidden-canvas" style="display: none;"></canvas>

<!-- GIF生成库 -->
<script src="<%- config.root %>js/gif.js"></script>

<!-- 动态背景生成器专用脚本 -->
<script src="<%- config.root %>js/background-generator.js?v=<%= Date.now() %>"></script>
